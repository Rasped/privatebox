#!/bin/sh
# FreeBSD Auto-installer configuration
# Generated by PrivateBox automation

# Non-interactive mode
export ASSUME_ALWAYS_YES=YES
export nonInteractive=YES

# Log all output
exec > /tmp/installerconfig.log 2>&1

echo "=== FreeBSD Automated Installation ==="
echo "Started: $(date)"

# Disk configuration - use first available disk
DISKNAME=$(sysctl -n kern.disks | awk '{print $1}')

echo "Starting automated FreeBSD installation on disk: $DISKNAME"

# Destroy any existing partition table
gpart destroy -F $DISKNAME || true

# Create GPT partition scheme
gpart create -s gpt $DISKNAME

# Create partitions
gpart add -t freebsd-boot -l boot0 -s 512k $DISKNAME
gpart add -t freebsd-swap -l swap0 -s 2G $DISKNAME
gpart add -t freebsd-ufs -l root0 $DISKNAME

# Install bootcode
gpart bootcode -b /boot/pmbr -p /boot/gptboot -i 1 $DISKNAME

# Create UFS filesystem with soft updates
newfs -U /dev/gpt/root0

# Mount root filesystem
mount /dev/gpt/root0 /mnt

# Extract base system
echo "Installing FreeBSD base system..."
cd /mnt && tar --unlink -xpJf /usr/freebsd-dist/base.txz

# Extract kernel
echo "Installing FreeBSD kernel..."
cd /mnt && tar --unlink -xpJf /usr/freebsd-dist/kernel.txz

# Basic system configuration in rc.conf
echo "Configuring system..."
cat > /mnt/etc/rc.conf << 'RCCONF'
# Hostname
hostname="freebsd-test"

# Network configuration
ifconfig_vtnet0="inet 192.168.1.99 netmask 255.255.255.0"
defaultrouter="192.168.1.1"

# System services
sshd_enable="YES"
ntpd_enable="YES"
dumpdev="AUTO"

# Security
clear_tmp_enable="YES"
sendmail_enable="NO"
sendmail_submit_enable="NO"
sendmail_outbound_enable="NO"
sendmail_msp_queue_enable="NO"
RCCONF

# DNS configuration
cat > /mnt/etc/resolv.conf << 'RESOLV'
nameserver 1.1.1.1
nameserver 8.8.8.8
RESOLV

# Time zone configuration
cp /mnt/usr/share/zoneinfo/UTC /mnt/etc/localtime
echo "UTC" > /mnt/etc/timezone

# Create fstab
cat > /mnt/etc/fstab << 'FSTAB'
/dev/gpt/root0 / ufs rw 1 1
/dev/gpt/swap0 none swap sw 0 0
FSTAB

# Enable serial console for Proxmox/VM environments
cat >> /mnt/boot/loader.conf << 'LOADER'
# Serial console configuration
console="comconsole"
boot_multicons="YES"
comconsole_speed="115200"
LOADER

# Create user account
echo "Creating user account: fbsduser"

# Simple password hash for testing
USER_HASH='$2b$10$invalid'
echo "fbsduser:${USER_HASH}:1001:1001::0:0:FreeBSD User:/home/fbsduser:/bin/sh" >> /mnt/etc/master.passwd

# Create group
echo "fbsduser:*:1001:" >> /mnt/etc/group

# Add user to wheel group for sudo access
echo "wheel:*:0:root,fbsduser" > /tmp/wheel_group
grep -v "^wheel:" /mnt/etc/group >> /tmp/wheel_group
mv /tmp/wheel_group /mnt/etc/group

# Create home directory
mkdir -p /mnt/home/fbsduser
chroot /mnt chown 1001:1001 /home/fbsduser
chroot /mnt chmod 755 /home/fbsduser

# Rebuild password database
chroot /mnt pwd_mkdb -p /etc/master.passwd

# Bootstrap pkg and install essential packages
echo "Installing essential packages..."
chroot /mnt env ASSUME_ALWAYS_YES=YES /usr/sbin/pkg bootstrap -f || true

# Install essential packages
ESSENTIAL_PACKAGES="sudo bash nano curl wget"
chroot /mnt pkg install -y $ESSENTIAL_PACKAGES || true

# Signal successful installation
echo "FreeBSD installation completed successfully!" > /mnt/tmp/install-complete
echo "Installation completed at: $(date)" >> /mnt/tmp/install-complete
echo "Disk: $DISKNAME" >> /mnt/tmp/install-complete
echo "Hostname: freebsd-test" >> /mnt/tmp/install-complete
echo "User: fbsduser" >> /mnt/tmp/install-complete

# Copy installation log to installed system
cp /tmp/installerconfig.log /mnt/tmp/ || true

# Final sync and unmount
echo "Syncing filesystems..."
sync
sync
echo "Unmounting installation target..."
umount /mnt

echo "=== FreeBSD installation complete ==="
echo "Completed: $(date)"
echo "System will now shut down..."

# Shutdown after installation
shutdown -p now