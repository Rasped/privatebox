DISTRIBUTIONS="base.txz kernel.txz"
PARTITIONS="vtbd0"
BSDINSTALL_DISTSITE="http://download.freebsd.org/ftp/releases/amd64/14.3-RELEASE/"

#!/bin/sh
# Post-extract config; runs in installer env, target at /mnt
set -eu
T=/mnt

# Basic system
sysrc -R "$T" hostname="freebsd-privatebox"
sysrc -R "$T" ifconfig_vtnet0="DHCP"
sysrc -R "$T" sshd_enable="YES"

# Serial console for Proxmox "terminal"
{
  echo 'boot_multicons="YES"'
  echo 'boot_serial="YES"'
  echo 'comconsole_speed="115200"'
  echo 'console="comconsole,vidconsole"'
} >> "$T/boot/loader.conf"

# Enable getty on serial
if grep -q '^ttyu0' "$T/etc/ttys"; then
  sed -i '' 's/^ttyu0.*/ttyu0  "\/usr\/libexec\/getty 3wire"  vt100  on  secure/' "$T/etc/ttys"
fi

# Users
echo "privatebox123" | chroot "$T" pw usermod root -h 0
chroot "$T" pw useradd freebsd -m -G wheel -s /bin/sh || true
echo "privatebox123" | chroot "$T" pw usermod freebsd -h 0