# Caddy Configuration for PrivateBox Services
# Generated by Ansible - Do not edit directly
# Running on Management VM, proxying to localhost services

# Global options
{
    # Use internal CA for .lan domains
    local_certs

    # Admin API endpoint (internal only)
    admin localhost:2019

    # Certificate storage
    storage file_system {
        root /data
    }
}

# Health check endpoint
:80 {
    respond /health "OK" 200
}

# Redirect HTTP to HTTPS for .lan domains
http:// {
    @lan_domains {
        host *.lan
    }
    redir @lan_domains https://{host}{uri} permanent
}

# Homer Dashboard
homer.lan {
    tls internal

    reverse_proxy 10.10.20.10:8081 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }

    header {
        -Server
        X-Content-Type-Options nosniff
    }
}

# Headplane (Headscale Web UI)
headplane.lan {
    tls internal

    reverse_proxy 10.10.20.10:8080 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }

    header {
        -Server
        X-Content-Type-Options nosniff
    }
}

# Portainer (Container Management)
portainer.lan {
    tls internal

    reverse_proxy https://10.10.20.10:1443 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}

        transport http {
            tls_insecure_skip_verify
        }
    }

    header {
        -Server
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
    }
}

# Semaphore (Ansible Automation)
semaphore.lan {
    tls internal

    reverse_proxy https://10.10.20.10:2443 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}

        transport http {
            tls_insecure_skip_verify
        }
    }

    header {
        -Server
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
    }
}

# AdGuard Home (DNS & Ad Blocking)
adguard.lan {
    tls internal

    reverse_proxy https://10.10.20.10:3443 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}

        transport http {
            tls_insecure_skip_verify
        }
    }

    header {
        -Server
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
    }
}

# Headscale (VPN Control Server)
headscale.lan {
    tls internal

    reverse_proxy https://10.10.20.10:4443 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}

        transport http {
            tls_insecure_skip_verify
        }
    }

    header {
        -Server
        X-Content-Type-Options nosniff
    }
}

# OPNsense (Firewall & Router)
opnsense.lan {
    tls internal

    reverse_proxy https://10.10.20.1 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}

        transport http {
            tls_insecure_skip_verify
        }
    }

    header {
        -Server
        X-Content-Type-Options nosniff
    }
}

# Proxmox (Hypervisor)
proxmox.lan {
    tls internal

    reverse_proxy https://10.10.20.20:8006 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}

        transport http {
            tls_insecure_skip_verify
        }
    }

    header {
        -Server
        X-Content-Type-Options nosniff
    }
}

# Catch-all for undefined .lan services
*.lan {
    tls internal
    respond "Service not configured" 404
}
