# Caddy Configuration for PrivateBox Services
# Generated by Ansible - Do not edit directly

# Global options
{
    # Use internal CA for .lan domains
    local_certs
    
    # Admin API endpoint (internal only)
    admin localhost:2019
}

# Health check endpoint
:80 {
    respond /health "OK" 200
}

# HTTPS Services
{% for service in privatebox_services %}
# {{ service.description | default(service.name) }}
{{ service.domain }} {
    # Use internal certificates for .lan domains
    tls internal

    # Reverse proxy to service
    reverse_proxy {{ ansible_default_ipv4.address }}:{{ service.port }} {
        # Add common headers
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        
        # Health check for backend
        health_uri /
        health_interval 30s
        health_timeout 5s
    }

    # Security headers
    header {
        # Disable FLoC tracking
        Permissions-Policy interest-cohort=()
        
        # Enable HSTS for HTTPS
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        
        # Prevent clickjacking
        X-Frame-Options DENY
        
        # Prevent content type sniffing
        X-Content-Type-Options nosniff
        
        # Basic XSS protection
        X-XSS-Protection "1; mode=block"
        
        # Remove server header
        -Server
    }

    # Logging
    log {
        output file /var/log/caddy/{{ service.name }}.log {
            roll_size 10mb
            roll_keep 5
            roll_keep_for 720h
        }
        format console
        level INFO
    }
}

{% endfor %}
# Catch-all for undefined services
https://*.lan {
    tls internal
    respond "Service not configured" 404
}