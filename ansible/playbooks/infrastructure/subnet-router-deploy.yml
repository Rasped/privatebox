---
- name: "Subnet Router: Create Alpine VM"
  hosts: proxmox
  gather_facts: true

  environment:
    ANSIBLE_JINJA2_NATIVE: "True"

  vars:
    # VM configuration
    vmid: 101
    vm_name: "privatebox-subnet-router"
    vm_memory: 256
    vm_cores: 1
    vm_disk_size: "2G"
    vm_storage: "local-lvm"

    # Network configuration - Dual IPs
    lan_ip: "10.10.10.10"
    lan_netmask: "24"
    lan_gateway: "10.10.10.1"
    services_ip: "10.10.20.11"
    services_netmask: "24"

    # Alpine Linux cloud image
    alpine_version: "3.19"
    alpine_image_url: "https://dl-cdn.alpinelinux.org/alpine/v{{ alpine_version }}/releases/cloud/nocloud_alpine-{{ alpine_version }}.0-x86_64-bios-cloudinit-r0.qcow2"
    alpine_image_name: "nocloud_alpine-{{ alpine_version }}.0-x86_64-bios-cloudinit-r0.qcow2"
    image_cache_dir: "/var/lib/vz/template/cache"

    # Semaphore configuration
    semaphore_url: "http://10.10.20.10:3000"
    project_id: 1

    # Template configuration for Semaphore
    template_config:
      semaphore_environment: "SemaphoreAPI"
      semaphore_inventory: "proxmox"

  tasks:
    - name: Display deployment header
      debug:
        msg:
          - "=========================================="
          - "   SUBNET ROUTER VM CREATION"
          - "=========================================="
          - "VMID: {{ vmid }}"
          - "LAN IP: {{ lan_ip }}"
          - "Services IP: {{ services_ip }}"

    # Pre-flight checks
    - name: Check if VM already exists
      command: qm status {{ vmid }}
      register: vm_exists
      failed_when: false
      changed_when: false

    - name: Fail if VM already exists
      fail:
        msg: "VM {{ vmid }} already exists. Delete it first or choose a different VMID."
      when: vm_exists.rc == 0

    - name: Create image cache directory
      file:
        path: "{{ image_cache_dir }}"
        state: directory
        mode: '0755'

    # Download Alpine cloud image
    - name: Check if Alpine image exists
      stat:
        path: "{{ image_cache_dir }}/{{ alpine_image_name }}"
      register: alpine_image_stat

    - name: Download Alpine cloud image
      get_url:
        url: "{{ alpine_image_url }}"
        dest: "{{ image_cache_dir }}/{{ alpine_image_name }}"
        mode: '0644'
      when: not alpine_image_stat.stat.exists

    # Create cloud-init configuration
    - name: Enable snippets on local storage
      command: pvesm set local --content vztmpl,iso,backup,snippets
      failed_when: false
      changed_when: false

    - name: Create snippets directory
      file:
        path: /var/lib/vz/snippets
        state: directory
        mode: '0755'

    - name: Generate cloud-init user-data
      copy:
        dest: "/var/lib/vz/snippets/subnet-router-{{ vmid }}.yml"
        mode: '0644'
        content: |
          #cloud-config
          hostname: {{ vm_name }}
          manage_etc_hosts: true

          users:
            - name: alpine
              sudo: ALL=(ALL) NOPASSWD:ALL
              shell: /bin/sh
              lock_passwd: false
              plain_text_passwd: alpine

          ssh_pwauth: true

          package_update: true
          package_upgrade: true

          packages:
            - curl
            - ca-certificates

          write_files:
            - path: /etc/network/interfaces
              permissions: '0644'
              content: |
                auto lo
                iface lo inet loopback

                auto eth0
                iface eth0 inet static
                    address {{ lan_ip }}/{{ lan_netmask }}
                    gateway {{ lan_gateway }}
                    dns-nameservers {{ lan_gateway }}

                auto eth1
                iface eth1 inet static
                    address {{ services_ip }}/{{ services_netmask }}

          runcmd:
            - echo "Subnet router VM ready"

          final_message: "Alpine subnet router VM deployed after $UPTIME seconds"

    # Create VM
    - name: Create VM {{ vmid }}
      command: >
        qm create {{ vmid }}
        --name {{ vm_name }}
        --memory {{ vm_memory }}
        --cores {{ vm_cores }}
        --cpu host
        --net0 virtio,bridge=vmbr1,tag=10
        --net1 virtio,bridge=vmbr1,tag=20
        --serial0 socket
        --vga serial0
        --agent enabled=1
      register: vm_created

    - name: Import disk image
      command: qm importdisk {{ vmid }} {{ image_cache_dir }}/{{ alpine_image_name }} {{ vm_storage }}
      when: vm_created is succeeded

    - name: Attach and configure disk
      command: >
        qm set {{ vmid }}
        --scsihw virtio-scsi-pci
        --scsi0 {{ vm_storage }}:vm-{{ vmid }}-disk-0
        --boot c
        --bootdisk scsi0
      when: vm_created is succeeded

    - name: Resize disk
      command: qm resize {{ vmid }} scsi0 {{ vm_disk_size }}
      when: vm_created is succeeded

    - name: Add cloud-init drive
      command: qm set {{ vmid }} --ide2 {{ vm_storage }}:cloudinit
      when: vm_created is succeeded

    - name: Enable auto-start
      command: qm set {{ vmid }} --onboot 1
      when: vm_created is succeeded

    - name: Configure cloud-init network
      command: >
        qm set {{ vmid }}
        --ipconfig0 ip={{ lan_ip }}/{{ lan_netmask }},gw={{ lan_gateway }}
        --ipconfig1 ip={{ services_ip }}/{{ services_netmask }}
        --nameserver {{ lan_gateway }}
        --cicustom "user=local:snippets/subnet-router-{{ vmid }}.yml"
      when: vm_created is succeeded

    - name: Start VM
      command: qm start {{ vmid }}
      when: vm_created is succeeded

    - name: Wait for VM to be running
      command: qm status {{ vmid }}
      register: vm_status
      until: vm_status.stdout.find('running') != -1
      retries: 30
      delay: 2

    - name: Wait for SSH to be available on Services IP
      wait_for:
        host: "{{ services_ip }}"
        port: 22
        delay: 10
        timeout: 180

    - name: Test SSH connection with password
      command: sshpass -p alpine ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null alpine@{{ services_ip }} "hostname"
      register: ssh_test
      changed_when: false

    # Generate SSH key on Alpine VM
    - name: Generate SSH key pair on Alpine VM
      command: >
        sshpass -p alpine ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null alpine@{{ services_ip }}
        "mkdir -p /home/alpine/.ssh &&
        ssh-keygen -t ed25519 -f /home/alpine/.ssh/id_ed25519 -N '' -C 'subnet-router@privatebox' &&
        cat /home/alpine/.ssh/id_ed25519.pub >> /home/alpine/.ssh/authorized_keys &&
        chmod 700 /home/alpine/.ssh &&
        chmod 600 /home/alpine/.ssh/authorized_keys /home/alpine/.ssh/id_ed25519"
      register: keygen_result
      changed_when: true

    - name: Retrieve private key from Alpine VM
      command: sshpass -p alpine ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null alpine@{{ services_ip }} "cat /home/alpine/.ssh/id_ed25519"
      register: private_key_content
      changed_when: false

    - name: Retrieve public key from Alpine VM
      command: sshpass -p alpine ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null alpine@{{ services_ip }} "cat /home/alpine/.ssh/id_ed25519.pub"
      register: public_key_content
      changed_when: false

    - name: Save private key to temporary file
      copy:
        content: "{{ private_key_content.stdout }}"
        dest: "/tmp/subnet-router-{{ vmid }}-private-key"
        mode: '0600'

    - name: Read private key from file
      slurp:
        src: "/tmp/subnet-router-{{ vmid }}-private-key"
      register: private_key_file

    # Register SSH key in Semaphore
    - name: Check if SSH key already exists in Semaphore
      uri:
        url: "{{ semaphore_url }}/api/project/{{ project_id }}/keys"
        method: GET
        headers:
          Authorization: "Bearer {{ SEMAPHORE_API_TOKEN }}"
        status_code: [200]
      register: existing_keys

    - name: Parse existing key ID
      set_fact:
        existing_key_id: "{{ (existing_keys.json | selectattr('name', 'equalto', 'subnet-router') | first).id | default(0) }}"

    - name: Register SSH key in Semaphore
      uri:
        url: "{{ semaphore_url }}/api/project/{{ project_id }}/keys"
        method: POST
        headers:
          Authorization: "Bearer {{ SEMAPHORE_API_TOKEN }}"
        body: |
          {
            "name": "subnet-router",
            "type": "ssh",
            "project_id": {{ project_id | int }},
            "ssh": {
              "private_key": {{ (private_key_file.content | b64decode).decode('utf-8') | to_json }}
            }
          }
        status_code: [201, 204]
      register: ssh_key_response
      when: existing_key_id | int == 0

    - name: Set SSH key ID
      set_fact:
        ssh_key_id: "{{ (ssh_key_response.json.id if existing_key_id | int == 0 else existing_key_id) | int }}"

    # Create inventory in Semaphore
    - name: Check if inventory already exists
      uri:
        url: "{{ semaphore_url }}/api/project/{{ project_id }}/inventory"
        method: GET
        headers:
          Authorization: "Bearer {{ SEMAPHORE_API_TOKEN }}"
        status_code: [200]
      register: existing_inventories

    - name: Parse existing inventory ID
      set_fact:
        existing_inventory_id: "{{ (existing_inventories.json | selectattr('name', 'equalto', 'subnet-router') | first).id | default(0) }}"

    - name: Build inventory YAML
      set_fact:
        inventory_yaml: |
          all:
            hosts:
              subnet-router:
                ansible_host: {{ services_ip }}
                ansible_user: alpine

    - name: Create subnet-router inventory in Semaphore
      uri:
        url: "{{ semaphore_url }}/api/project/{{ project_id }}/inventory"
        method: POST
        headers:
          Authorization: "Bearer {{ SEMAPHORE_API_TOKEN }}"
        body_format: json
        body:
          name: "subnet-router"
          type: "static"
          project_id: "{{ project_id | int }}"
          inventory: "{{ inventory_yaml }}"
          ssh_key_id: "{{ ssh_key_id | int }}"
        status_code: [201, 204]
      register: inventory_response
      when: existing_inventory_id | int == 0

    - name: Remove temporary private key file
      file:
        path: "/tmp/subnet-router-{{ vmid }}-private-key"
        state: absent

    - name: Display deployment summary
      debug:
        msg:
          - ""
          - "=========================================="
          - "   SUBNET ROUTER DEPLOYMENT COMPLETE"
          - "=========================================="
          - ""
          - "VM Details:"
          - "  VM ID: {{ vmid }}"
          - "  VM Name: {{ vm_name }}"
          - "  LAN IP: {{ lan_ip }}"
          - "  Services IP: {{ services_ip }}"
          - "  SSH Test: {{ ssh_test.stdout }}"
          - ""
          - "Semaphore Integration:"
          - "  SSH Key: Registered as 'subnet-router'"
          - "  SSH Key ID: {{ ssh_key_id }}"
          - "  Inventory: Created as 'subnet-router'"
          - "  Public Key: {{ public_key_content.stdout }}"
          - ""
          - "Security Status:"
          - "  Password: alpine (TEMPORARY - change via Semaphore)"
          - "  SSH Key Auth: Enabled"
          - ""
          - "Next Steps:"
          - "  1. Run subnet router configuration playbook"
          - "  2. Secure VM (change password, disable password auth)"
          - ""
