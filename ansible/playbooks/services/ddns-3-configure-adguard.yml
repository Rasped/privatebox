---
- name: "DynDNS 3: Configure AdGuard"
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    # Template configuration for Semaphore
    template_config:
      semaphore_environment: "privatebox-env-passwords"
      semaphore_inventory: "privatebox-local"
      semaphore_category: "services"

    # Config file location (from ddns-2b)
    ddns_config_file: "/tmp/ddns-handoff.json"

    # AdGuard configuration
    adguard_ip: "10.10.20.10"
    adguard_port: 3443
    adguard_url: "https://{{ adguard_ip }}:{{ adguard_port }}"
    adguard_username: "admin"
    adguard_password: "{{ SERVICES_PASSWORD | default('changeme') }}"

    # Caddy configuration for service discovery
    caddy_config_dir: "/opt/caddy"
    management_vm_ip: "10.10.20.10"

    enable_debug: true

  tasks:
    # ============================================
    # Phase 1: Read Config File
    # ============================================

    - name: Check if config file exists
      stat:
        path: "{{ ddns_config_file }}"
      register: config_stat

    - name: Fail if config file not found
      fail:
        msg: |
          DynDNS config file not found at {{ ddns_config_file }}
          Please run 'DynDNS 2b: Configure OPNsense' first.
      when: not config_stat.stat.exists

    - name: Read DynDNS config
      slurp:
        src: "{{ ddns_config_file }}"
      register: ddns_config_raw
      no_log: true

    - name: Parse DynDNS config
      set_fact:
        ddns_config: "{{ ddns_config_raw.content | b64decode | from_json }}"
      no_log: true

    - name: Set domain from config
      set_fact:
        ddns_domain: "{{ ddns_config.ddns_domain }}"

    # ============================================
    # Phase 2: Validation
    # ============================================

    - name: Display configuration header
      debug:
        msg:
          - "========================================"
          - "   ADGUARD DNS REWRITES CONFIGURATION"
          - "========================================"
          - "Domain: {{ ddns_domain }}"
          - "AdGuard: {{ adguard_url }}"

    - name: Validate SERVICES_PASSWORD is set
      fail:
        msg: |
          SERVICES_PASSWORD not found in privatebox-env-passwords environment.
          This playbook requires the privatebox-env-passwords environment.
      when: adguard_password == 'changeme'

    # ============================================
    # Phase 3: Check AdGuard API Connectivity
    # ============================================

    - name: Test AdGuard API authentication
      uri:
        url: "{{ adguard_url }}/control/status"
        validate_certs: no
        method: GET
        user: "{{ adguard_username }}"
        password: "{{ adguard_password }}"
        force_basic_auth: true
        status_code: 200
      register: adguard_status

    - name: Display AdGuard status
      debug:
        msg: "✓ AdGuard API authenticated successfully (version {{ adguard_status.json.version }})"
      when: enable_debug | bool

    # ============================================
    # Phase 4: Discover Services from Caddyfile
    # ============================================

    - name: Extract services from Caddyfile on management VM
      shell: |
        ssh -o StrictHostKeyChecking=no root@{{ management_vm_ip }} "awk '
        /^[a-z]+\.lan \{/ {
          service = \$1
          gsub(/\.lan/, \"\", service)
          in_block = 1
          next
        }
        in_block && /reverse_proxy/ {
          print service
          in_block = 0
        }
        /^\}/ {
          in_block = 0
        }
        ' {{ caddy_config_dir }}/Caddyfile | grep -v '^\*'"
      register: caddyfile_parse
      changed_when: false

    - name: Build services list from parsed Caddyfile
      set_fact:
        discovered_services: "{{ caddyfile_parse.stdout_lines }}"

    - name: Display discovered services
      debug:
        msg: "Found {{ discovered_services | length }} services: {{ discovered_services | join(', ') }}"

    # ============================================
    # Phase 5: Get Existing DNS Rewrites
    # ============================================

    - name: Get existing DNS rewrites
      uri:
        url: "{{ adguard_url }}/control/rewrite/list"
        validate_certs: no
        method: GET
        user: "{{ adguard_username }}"
        password: "{{ adguard_password }}"
        force_basic_auth: true
        status_code: 200
      register: existing_rewrites

    - name: Display existing rewrites count
      debug:
        msg: "Found {{ existing_rewrites.json | length }} existing DNS rewrites"
      when: enable_debug | bool

    - name: Build list of existing custom domain rewrites
      set_fact:
        existing_domains: "{{ existing_rewrites.json | selectattr('domain', 'search', ddns_domain) | map(attribute='domain') | list }}"

    - name: Display existing custom domain rewrites
      debug:
        msg: "Existing rewrites for {{ ddns_domain }}: {{ existing_domains | join(', ') if existing_domains | length > 0 else 'none' }}"
      when: enable_debug | bool

    # ============================================
    # Phase 6: Add DNS Rewrites for Custom Domain
    # ============================================

    - name: Build list of services needing rewrites
      set_fact:
        services_to_add: "{{ discovered_services | reject('in', existing_domains | map('regex_replace', '\\.' + ddns_domain, '') | list) | list }}"

    - name: Display rewrites to add
      debug:
        msg: "Will add {{ services_to_add | length }} DNS rewrites ({{ services_to_add | join(', ') if services_to_add | length > 0 else 'none needed' }})"

    - name: Add DNS rewrites for custom domain
      when: services_to_add | length > 0
      uri:
        url: "{{ adguard_url }}/control/rewrite/add"
        validate_certs: no
        method: POST
        user: "{{ adguard_username }}"
        password: "{{ adguard_password }}"
        force_basic_auth: true
        body_format: json
        body:
          domain: "{{ item }}.{{ ddns_domain }}"
          answer: "{{ adguard_ip }}"
        status_code: 200
      register: rewrite_result
      loop: "{{ services_to_add }}"
      loop_control:
        label: "{{ item }}.{{ ddns_domain }} → {{ adguard_ip }}"

    - name: Display rewrite results
      when: services_to_add | length > 0
      debug:
        msg: "Successfully added {{ rewrite_result.results | selectattr('status', 'equalto', 200) | list | length }} DNS rewrites"

    # ============================================
    # Phase 7: Verification
    # ============================================

    - name: Get updated DNS rewrites list
      uri:
        url: "{{ adguard_url }}/control/rewrite/list"
        validate_certs: no
        method: GET
        user: "{{ adguard_username }}"
        password: "{{ adguard_password }}"
        force_basic_auth: true
        status_code: 200
      register: updated_rewrites

    - name: Filter custom domain rewrites
      set_fact:
        custom_rewrites: >-
          {{
            updated_rewrites.json |
            selectattr('domain', 'search', ddns_domain) |
            list
          }}

    - name: Display custom domain rewrites
      debug:
        msg:
          - "Custom domain rewrites ({{ custom_rewrites | length }}):"
          - "{{ custom_rewrites | map(attribute='domain') | list }}"
      when: enable_debug | bool

    - name: Verify all expected rewrites exist
      assert:
        that:
          - custom_rewrites | length >= discovered_services | length
        fail_msg: "Not all expected rewrites were added"
        success_msg: "✓ All expected rewrites verified"

    # ============================================
    # Phase 8: Display Summary
    # ============================================

    - name: Display final summary
      debug:
        msg:
          - "========================================"
          - "   ADGUARD DNS REWRITES - COMPLETE"
          - "========================================"
          - ""
          - "Custom Domain: {{ ddns_domain }}"
          - "DNS Rewrites Added: {{ services_to_add | length }}"
          - "Total Custom Rewrites: {{ custom_rewrites | length }}"
          - ""
          - "Services Now Accessible Via:"
          - "{% for service in discovered_services %}  - https://{{ service }}.{{ ddns_domain }}{% endfor %}"
          - ""
          - "Note:"
          - "  • These domains resolve internally to {{ adguard_ip }}"
          - "  • Existing .lan domains remain unchanged"
          - "  • External access requires Tailscale VPN"
          - ""
          - "Next Steps:"
          - "  1. Run 'DynDNS 4: Cleanup DNS Records' to remove stale ACME challenges"
          - "  2. Run 'DynDNS 5: Configure Caddy Let's Encrypt' to get valid certificates"
          - "  3. Services will be accessible with trusted TLS certificates"
          - ""
          - "========================================"
