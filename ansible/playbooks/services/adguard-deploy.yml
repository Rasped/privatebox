---
- name: "AdGuard 1: Deploy Container Service"
  hosts: privatebox-management
  become: true
  gather_facts: true
  
  vars:
    service_name: "AdGuard Home"
    service_description: "Network-wide ads & trackers blocking DNS server"
    service_tag: "adguard"
    
    # Template configuration for Semaphore
    template_config:
      semaphore_environment: "privatebox-env-passwords"
    
    # AdGuard default configuration - can be overridden by group_vars
    adguard_image: "adguard/adguardhome"
    adguard_version: "latest"
    adguard_web_port: 3443      # HTTPS web interface port
    adguard_dns_port: 53        # DNS service port
    adguard_dns_port_udp: 53    # DNS service UDP port
    adguard_setup_port: 3001    # Initial setup port
    adguard_dns_over_tls: 853   # DNS-over-TLS port
    adguard_data_dir: "/opt/privatebox/data/adguard"
    adguard_config_dir: "/opt/privatebox/config/adguard"
    
    # Default values for hands-off deployment (no prompts)
    confirm_deploy: true
    custom_web_port: "{{ adguard_web_port }}"
    
    # AdGuard admin credentials
    adguard_admin_username: "admin"
    # Use SERVICES_PASSWORD from Semaphore environment
    # Semaphore passes environment secrets as Ansible extra vars
    adguard_admin_password: "{{ SERVICES_PASSWORD | default('changeme') }}"
    
    # Quadlet configuration
    use_system_quadlet: true
    quadlet_system_path: "/etc/containers/systemd"
    quadlet_user_path: "{{ ansible_env.HOME }}/.config/containers/systemd"
    
    # Container runtime configuration
    container_image_registry: "docker.io"
    volume_mount_options: "Z"
    timezone: "UTC"
    container_security_label_disable: false
    container_no_new_privileges: true
    container_drop_capabilities: []
    # AdGuard needs root to bind to port 53, so we don't use user namespaces
    # container_user_namespace: "keep-id"
    
    # Health check configuration
    health_check_interval: "30s"
    health_check_retries: 3
    health_check_start_period: "60s"
    health_check_timeout: "10s"
    
    # Container management configuration
    container_log_driver: "journald"
    container_pull_policy: "missing"
    container_restart_policy: "always"
    container_restart_sec: 30
    
    # Systemd configuration
    systemd_timeout_start_sec: 900
    systemd_timeout_stop_sec: 90
    

  tasks:
    # Pre-deployment validation
    - name: "{{ service_name }} - Pre-deployment checks"
      when: confirm_deploy | bool
      tags: [adguard, preflight]
      block:
        - name: Check system requirements
          assert:
            that:
              - ansible_distribution in ["Ubuntu", "Debian"]
              - >
                (ansible_distribution == "Ubuntu" and ansible_distribution_version is version('22.04', '>=')) or
                (ansible_distribution == "Debian" and ansible_distribution_version is version('12', '>='))
            fail_msg: "This playbook requires Ubuntu 22.04+ or Debian 12+"
            
        - name: Check if Podman is installed
          command: which podman
          register: podman_check
          changed_when: false
          failed_when: false
          
        - name: Install Podman if not present
          when: podman_check.rc != 0
          block:
            - name: Update apt cache
              apt:
                update_cache: yes
                cache_valid_time: 3600
                
            - name: Install Podman
              apt:
                name:
                  - podman
                  - podman-compose
                  - containernetworking-plugins
                state: present
                
        - name: Check Podman version
          command: podman --version
          register: podman_version
          changed_when: false
          
        - name: Display Podman version
          debug:
            msg: "Podman version: {{ podman_version.stdout }}"
            
        # Note: systemd-resolved handling moved to activate-adguard-dns.yml
        # This keeps the VM's DNS independent during deployment
        - name: Check for port conflicts
          wait_for:
            port: "{{ item }}"
            state: stopped
            timeout: 1
          loop:
            - "{{ custom_web_port }}"
            - "{{ adguard_dns_port }}"
            - "{{ adguard_setup_port }}"
          ignore_errors: true
          register: port_check
          
        - name: Warn about port conflicts
          debug:
            msg: "WARNING: Port {{ item.item }} appears to be in use. Service may fail to start."
          loop: "{{ port_check.results }}"
          when: item.failed is defined and not item.failed

    # Main deployment
    - name: "{{ service_name }} - Deployment"
      when: confirm_deploy | bool
      tags: [adguard, deploy]
      block:
        - name: Create directory structure
          file:
            path: "{{ item.path }}"
            state: directory
            owner: "{{ item.owner | default(ansible_user) }}"
            group: "{{ item.group | default(ansible_user) }}"
            mode: "{{ item.mode | default('0755') }}"
          loop:
            - { path: "{{ adguard_data_dir }}" }
            - { path: "{{ adguard_config_dir }}" }
            - { path: "{{ quadlet_system_path if use_system_quadlet else quadlet_user_path }}" }
            
        - name: Set SELinux context for data directories
          when: ansible_selinux.status is defined and ansible_selinux.status == "enabled"
          command: |
            chcon -R -t container_file_t {{ item }}
          loop:
            - "{{ adguard_data_dir }}"
            - "{{ adguard_config_dir }}"
          changed_when: true

        - name: Configure AdGuard HTTPS-only
          copy:
            content: |
              http:
                address: 0.0.0.0:8080
              tls:
                enabled: true
                server_name: privatebox.local
                force_https: true
                port_https: 3000
                port_dns_over_tls: 853
                port_dns_over_quic: 784
                port_dnscrypt: 0
                allow_unencrypted_doh: false
                certificate_path: /certs/privatebox.crt
                private_key_path: /certs/privatebox.key
                strict_sni_check: false
            dest: "{{ adguard_config_dir }}/AdGuardHome.yaml"
            mode: '0644'
          when: not (adguard_config_dir + '/AdGuardHome.yaml') is file

        - name: Deploy Quadlet unit file
          template:
            src: ../../files/quadlet/adguard.container.j2
            dest: "{{ quadlet_system_path if use_system_quadlet else quadlet_user_path }}/adguard.container"
            owner: root
            group: root
            mode: '0644'
          register: quadlet_deployed
          
        - name: Reload systemd daemon
          systemd:
            daemon_reload: true
          when: quadlet_deployed.changed
            
        - name: Enable AdGuard Home service
          systemd:
            name: adguard.service
            enabled: true
            scope: "{{ 'system' if use_system_quadlet else 'user' }}"
            
        - name: Start AdGuard Home service
          systemd:
            name: adguard.service
            state: started
            scope: "{{ 'system' if use_system_quadlet else 'user' }}"
          register: service_start
          
        - name: Wait for AdGuard Home to be ready
          uri:
            url: "https://{{ ansible_default_ipv4.address }}:{{ custom_web_port }}/"
            validate_certs: no
            status_code: [200, 302]  # 302 is expected for initial setup redirect
            follow_redirects: none  # Don't follow to /install.html
            timeout: 10
          register: adguard_ready
          until: adguard_ready.status in [200, 302]
          retries: 6
          delay: 10
          when: service_start.changed

        - name: Configure firewall for AdGuard
          block:
            - name: Check if ufw is installed
              command: which ufw
              register: ufw_check
              changed_when: false
              failed_when: false
              
            - name: Configure ufw firewall rules
              when: ufw_check.rc == 0
              block:
                - name: Allow AdGuard web interface
                  ufw:
                    rule: allow
                    port: "{{ custom_web_port }}"
                    proto: tcp
                    comment: "AdGuard Home Web UI"
                    
                - name: Allow DNS TCP
                  ufw:
                    rule: allow
                    port: "{{ adguard_dns_port }}"
                    proto: tcp
                    comment: "AdGuard DNS TCP"
                    
                - name: Allow DNS UDP
                  ufw:
                    rule: allow
                    port: "{{ adguard_dns_port_udp }}"
                    proto: udp
                    comment: "AdGuard DNS UDP"
                    
                - name: Allow DNS-over-TLS if configured
                  ufw:
                    rule: allow
                    port: "{{ adguard_dns_over_tls }}"
                    proto: tcp
                    comment: "AdGuard DNS-over-TLS"
                  when: adguard_dns_over_tls is defined
                  
                - name: Note firewall configuration
                  debug:
                    msg: "Firewall rules configured for AdGuard Home services"
              rescue:
                - name: Note firewall configuration failure
                  debug:
                    msg: "Warning: Failed to configure firewall rules. Please configure manually if needed."

    # Post-deployment validation
    - name: "{{ service_name }} - Post-deployment validation"
      when: confirm_deploy | bool
      tags: [adguard, validate]
      block:
        - name: Check service status
          systemd:
            name: adguard.service
            scope: "{{ 'system' if use_system_quadlet else 'user' }}"
          register: service_status
          
        - name: Verify service is active
          assert:
            that:
              - service_status.status.ActiveState == "active"
            fail_msg: "AdGuard Home service is not active"
            
        - name: Check container status
          command: podman ps --filter "name=adguard-home" --format json
          register: container_status
          changed_when: false
          
        - name: Parse container info
          set_fact:
            container_info: "{{ container_status.stdout | from_json | first | default({}) }}"
          when: container_status.stdout
          
        - name: Display container status
          debug:
            msg:
              - "Container: {{ container_info.Names | default(['Not found']) | first }}"
              - "Status: {{ container_info.State | default('Unknown') }}"
              - "Image: {{ container_info.Image | default('Unknown') }}"
          when: container_info is defined
          
        - name: Note about DNS configuration
          debug:
            msg: "DNS will be configured automatically after AdGuard setup"
            
    # Display access information
    - name: "{{ service_name }} - Access information"
      when: confirm_deploy | bool
      tags: [adguard, info]
      block:
        - name: Generate service information
          set_fact:
            service_info:
              name: "{{ service_name }}"
              status: "{{ 'Active' if service_status.status.ActiveState == 'active' else 'Inactive' }}"
              web_url: "https://{{ ansible_default_ipv4.address }}:{{ custom_web_port }}"
              dns_server: "{{ ansible_default_ipv4.address }}"
              dns_port: "{{ adguard_dns_port }}"
              
        - name: Display access information
          debug:
            msg:
              - "=========================================="
              - "{{ service_name }} Deployment Complete!"
              - "=========================================="
              - ""
              - "Service Status: {{ service_info.status }}"
              - "DNS Status: Running on port {{ adguard_dns_port }}"
              - "System DNS: Not modified (run activate-adguard-dns.yml to activate)"
              - ""
              - "Web Interface: {{ service_info.web_url }}"
              - "Username: {{ adguard_admin_username }}"
              - "Password: Using SERVICES_PASSWORD from Semaphore"
              - ""
              - "DNS Server: {{ service_info.dns_server }}:{{ service_info.dns_port }}"
              - ""
              - "To use AdGuard as your DNS:"
              - "- Router: Set DNS to {{ service_info.dns_server }}"
              - "- Individual devices: Use {{ service_info.dns_server }}:{{ service_info.dns_port }}"
              - ""
              - "Service Management:"
              - "- Status: sudo systemctl status adguard.service"
              - "- Logs: sudo podman logs adguard-home"
              - "- Restart: sudo systemctl restart adguard.service"
              - "=========================================="
              
        - name: Save deployment info
          copy:
            content: |
              {{ service_name }} Deployment Information
              =====================================
              Deployed: {{ ansible_date_time.iso8601 }}
              Host: {{ inventory_hostname }}
              
              Access URLs:
              - Web Interface: {{ service_info.web_url }}
              - DNS Server: {{ service_info.dns_server }}:{{ service_info.dns_port }}
              
              Service: adguard.service
              Container: adguard-home
              
              Data Directory: {{ adguard_data_dir }}
              Config Directory: {{ adguard_config_dir }}
            dest: "/opt/privatebox/deployment-info-adguard.txt"
            mode: '0644'

    # Automatic AdGuard configuration
    - name: "{{ service_name }} - Automatic configuration"
      when: confirm_deploy | bool
      tags: [adguard, configure]
      block:
        - name: Wait for AdGuard API to be available
          uri:
            url: "https://{{ ansible_default_ipv4.address }}:{{ custom_web_port }}/control/status"
            validate_certs: no
            method: GET
            status_code: [200, 302, 401]  # 401 means configured but needs auth
            follow_redirects: none
            timeout: 10
          register: api_status
          until: api_status.status in [200, 302, 401]
          retries: 12
          delay: 5
          
        - name: Check if AdGuard is already configured
          uri:
            url: "https://{{ ansible_default_ipv4.address }}:{{ custom_web_port }}/control/status"
            validate_certs: no
            method: GET
            follow_redirects: none
            status_code: [200, 302, 401]  # Accept all expected statuses
          register: status_check
          failed_when: false

        - name: Display configuration status
          debug:
            msg: >
              AdGuard status: {{ 'Needs initial configuration' if status_check.status == 302
              else 'Already configured' if status_check.status == 401
              else 'Accessible and running' }}

        - name: Configure AdGuard if not already configured
          when: status_check.status == 302  # Only configure if it redirects to setup
          block:
            - name: Check initial configuration
              uri:
                url: "https://{{ ansible_default_ipv4.address }}:{{ custom_web_port }}/control/install/check_config"
                validate_certs: no
                method: POST
                body_format: json
                body:
                  web:
                    port: 3000
                    ip: "0.0.0.0"  # Bind to all interfaces inside container
                  dns:
                    port: "{{ adguard_dns_port }}"
                    ip: "0.0.0.0"  # Bind to all interfaces inside container
                    autofix: false
                  set_static_ip: false
                status_code: 200
              register: config_check

            - name: Apply AdGuard configuration
              uri:
                url: "https://{{ ansible_default_ipv4.address }}:{{ custom_web_port }}/control/install/configure"
                validate_certs: no
                method: POST
                body_format: json
                body:
                  web:
                    port: 3000
                    ip: "0.0.0.0"  # Bind to all interfaces inside container
                  dns:
                    port: "{{ adguard_dns_port }}"
                    ip: "0.0.0.0"  # Bind to all interfaces inside container
                  username: "{{ adguard_admin_username }}"
                  password: "{{ adguard_admin_password }}"
                status_code: 200
                timeout: 30
              register: configure_result
              
            - name: Wait for AdGuard to restart after configuration
              pause:
                seconds: 20
                
            - name: Verify AdGuard is now configured and running
              uri:
                url: "https://{{ ansible_default_ipv4.address }}:{{ custom_web_port }}/control/status"
                validate_certs: no
                method: GET
                user: "{{ adguard_admin_username }}"
                password: "{{ adguard_admin_password }}"
                force_basic_auth: true
                status_code: 200
              register: final_status
              until: final_status.status == 200
              retries: 5
              delay: 5
              
            - name: Display configuration status
              debug:
                msg: "AdGuard is now configured. DNS port: {{ final_status.json.dns_port }}, Protection enabled: {{ final_status.json.protection_enabled }}"
                
        - name: Configure recommended settings
          when: status_check.status in [200, 401]  # Configure if accessible (200) or needs auth (401)
          block:
            - name: Enable protection if not already enabled
              uri:
                url: "https://{{ ansible_default_ipv4.address }}:{{ custom_web_port }}/control/protection"
                validate_certs: no
                method: POST
                user: "{{ adguard_admin_username }}"
                password: "{{ adguard_admin_password }}"
                force_basic_auth: true
                body_format: json
                body:
                  enabled: true
                status_code: 200
              register: protection_result
              
            - name: Configure upstream DNS servers (Quad9 + Unbound fallback)
              uri:
                url: "https://{{ ansible_default_ipv4.address }}:{{ custom_web_port }}/control/dns_config"
                validate_certs: no
                method: POST
                user: "{{ adguard_admin_username }}"
                password: "{{ adguard_admin_password }}"
                force_basic_auth: true
                body_format: json
                body:
                  upstream_dns:
                    - "tls://dns.quad9.net"       # Primary Quad9 DNS-over-TLS
                    - "tls://dns11.quad9.net"     # Secondary Quad9 DNS-over-TLS
                    - "10.10.20.1"               # Unbound fallback on OPNsense Services VLAN
                  bootstrap_dns:
                    - "9.9.9.9"                   # Quad9 for bootstrap
                    - "149.112.112.112"           # Quad9 secondary for bootstrap
                    - "1.1.1.1"                   # Cloudflare as additional bootstrap
                  upstream_mode: "parallel"       # Query all servers in parallel for fastest response
                  cache_size: 4194304            # 4MB cache
                  cache_ttl_min: 600             # Min TTL 10 minutes
                  cache_ttl_max: 86400           # Max TTL 24 hours
                  protection_enabled: true       # Enable protection
                status_code: 200
              register: dns_config_result

            - name: Configure DNS blocklists
              uri:
                url: "https://{{ ansible_default_ipv4.address }}:{{ custom_web_port }}/control/filtering/add_url"
                validate_certs: no
                method: POST
                user: "{{ adguard_admin_username }}"
                password: "{{ adguard_admin_password }}"
                force_basic_auth: true
                body_format: json
                body:
                  name: "{{ item.name }}"
                  url: "{{ item.url }}"
                  whitelist: false
                status_code: 200
              register: blocklist_result
              loop:
                - { name: "OISD Basic", url: "https://abp.oisd.nl/basic/" }
                - { name: "Steven Black Hosts", url: "https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts" }
              loop_control:
                label: "{{ item.name }}"
              ignore_errors: true  # Ignore if blocklist already exists

            # Note: Blocklists update automatically when added, no need to force refresh
            # Forcing refresh immediately after adding causes 500 error: "filters update procedure is already running"
            - name: Wait for blocklists to finish auto-updating
              pause:
                seconds: 5
                prompt: "Waiting for AdGuard to finish updating blocklists..."

            - name: Load DNS rewrites configuration
              include_vars:
                file: ../../templates/adguard/dns-rewrites.yml
                name: dns_rewrites

            - name: Configure DNS rewrites for .lan domains
              uri:
                url: "https://{{ ansible_default_ipv4.address }}:{{ custom_web_port }}/control/rewrite/add"
                validate_certs: no
                method: POST
                user: "{{ adguard_admin_username }}"
                password: "{{ adguard_admin_password }}"
                force_basic_auth: true
                body_format: json
                body:
                  domain: "{{ item.domain }}"
                  answer: "{{ item.answer }}"
                status_code: 200
              register: rewrite_result
              loop: "{{ dns_rewrites.rewrites }}"
              loop_control:
                label: "{{ item.domain }} → {{ item.answer }}"
              ignore_errors: true  # Ignore if rewrite already exists

        - name: Verify DNS configuration
          block:
            - name: Check AdGuard DNS port is listening
              wait_for:
                host: "{{ ansible_default_ipv4.address }}"
                port: "{{ adguard_dns_port }}"
                timeout: 5
                msg: "AdGuard DNS service is not listening on port {{ adguard_dns_port }}"
              register: dns_port_check

            - name: Display DNS service status
              debug:
                msg: "AdGuard DNS service is {{ 'ACTIVE' if dns_port_check is succeeded else 'NOT ACTIVE' }} on port {{ adguard_dns_port }}"

            - name: Test Unbound fallback connectivity
              wait_for:
                host: 10.10.20.1
                port: 53
                timeout: 5
                msg: "Unbound DNS on OPNsense (10.10.20.1:53) is not accessible"
              ignore_errors: true  # Continue even if Unbound is not available
              register: unbound_check

            - name: Display Unbound fallback status
              debug:
                msg: >
                  Unbound fallback {{ 'AVAILABLE' if unbound_check is succeeded
                  else 'NOT AVAILABLE - AdGuard will use Quad9 only' }}

            - name: Get AdGuard statistics
              uri:
                url: "https://{{ ansible_default_ipv4.address }}:{{ custom_web_port }}/control/stats"
                validate_certs: no
                method: GET
                user: "{{ adguard_admin_username }}"
                password: "{{ adguard_admin_password }}"
                force_basic_auth: true
                status_code: 200
              register: stats_result
              ignore_errors: true  # Don't fail if stats aren't available yet

            - name: Display DNS configuration summary
              debug:
                msg:
                  - "=========================================="
                  - "DNS Configuration Summary:"
                  - "=========================================="
                  - "Primary DNS: Quad9 (TLS)"
                  - "Fallback DNS: {{ 'Unbound at 10.10.20.1:53' if unbound_check is succeeded else 'Quad9 secondary' }}"
                  - "Blocklists: OISD Basic + Steven Black Hosts"
                  - "Ad blocking: {{ 'ACTIVE - ' + (stats_result.json.num_blocked_filtering | default(0) | string) + ' queries blocked' if stats_result.json.num_blocked_filtering is defined else 'ACTIVE' }}"
                  - "DNS queries served: {{ stats_result.json.num_dns_queries | default('N/A') }}"
                  - "Queries blocked: {{ stats_result.json.num_blocked_filtering | default('N/A') }}"
                  - "=========================================="

    # Switch system DNS to AdGuard
    - name: "{{ service_name }} - Activate as system DNS"
      when: confirm_deploy | bool
      tags: [adguard, dns-switch]
      block:
        - name: Create resolved.conf.d directory
          file:
            path: /etc/systemd/resolved.conf.d
            state: directory
            mode: '0755'

        - name: Update systemd-resolved to use AdGuard DNS
          copy:
            content: |
              [Resolve]
              DNS=10.10.20.10
              FallbackDNS=9.9.9.9
              Domains=~.
            dest: /etc/systemd/resolved.conf.d/adguard.conf
            mode: '0644'

        - name: Restart systemd-resolved
          systemd:
            name: systemd-resolved
            state: restarted

        - name: Wait for DNS to stabilize
          wait_for:
            timeout: 5

        - name: Display DNS switch result
          debug:
            msg: "✓ System DNS switched to AdGuard at 10.10.20.10"

  handlers:
    - name: restart adguard
      systemd:
        name: adguard.service
        state: restarted
        scope: "{{ 'system' if use_system_quadlet else 'user' }}"