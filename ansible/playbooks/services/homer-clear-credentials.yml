---
# Homer Dashboard - Clear Credentials Banner
# Removes credentials from dashboard and deletes credential files

- name: "Homer: Clear Credentials Banner"
  hosts: privatebox-management
  become: true
  gather_facts: no

  vars:
    # Template configuration for Semaphore
    template_config:
      semaphore_environment: "Empty"
      semaphore_inventory: "privatebox-management"
      semaphore_category: "services"

    config_dir: "/opt/homer"

    # Template variables for Homer config
    custom_domain: "lan"

  tasks:
    - name: Display operation header
      debug:
        msg:
          - "=========================================="
          - "   CLEAR CREDENTIALS BANNER"
          - "=========================================="
          - "This will remove the credentials banner from Homer dashboard"

    # ============================================
    # Phase 1: Update Homer Configuration
    # ============================================

    - name: Backup existing Homer configuration
      copy:
        src: "{{ config_dir }}/config.yml"
        dest: "{{ config_dir }}/config.yml.bak"
        remote_src: yes
        mode: '0644'

    - name: Re-render Homer configuration without credentials
      template:
        src: ../../templates/homer/config.yml.j2
        dest: "{{ config_dir }}/config.yml"
        owner: root
        group: root
        mode: '0644'
      register: config_updated

    # ============================================
    # Phase 2: Restart Homer Service
    # ============================================

    - name: Restart Homer service
      when: config_updated.changed
      systemd:
        name: homer.service
        state: restarted

    - name: Wait for Homer to start
      when: config_updated.changed
      wait_for:
        timeout: 5

    - name: Check Homer service status
      systemd:
        name: homer.service
      register: homer_status

    - name: Display Homer status
      debug:
        msg: "Homer service: {{ homer_status.status.ActiveState }}"

    - name: Fail if Homer is not running
      fail:
        msg: "Homer service failed to start"
      when: homer_status.status.ActiveState != "active"

    # ============================================
    # Phase 3: Display Summary
    # ============================================

    - name: Display completion summary
      debug:
        msg:
          - "=========================================="
          - "   CREDENTIALS CLEARED"
          - "=========================================="
          - ""
          - "Actions completed:"
          - "  • Re-rendered Homer configuration"
          - "  • Restarted Homer service"
          - ""
          - "Result:"
          - "  • Homer dashboard: https://privatebox.lan"
          - ""
          - "=========================================="
