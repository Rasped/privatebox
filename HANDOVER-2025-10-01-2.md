# HANDOVER: SSH Key Deployment Fixed, Environment Creation Blocked - 2025-10-01

## Executive Summary

✅ **SUCCESS**: SSH key deployment via ephemeral API key is WORKING
❌ **BLOCKED**: OPNsense Semaphore Integration fails to create OPNsenseAPI environment due to Ansible YAML/JSON type handling

---

## What Works Now

### 1. SSH Key Deployment (opnsense-secure-access.yml) ✅

**Playbook**: `ansible/playbooks/services/opnsense-secure-access.yml`

**Flow**:
1. **Phase 1**: Intelligence gathering (detect SSH key status, test passwords)
2. **Phase 2**: Password synchronization (BEFORE SSH key setup)
   - Uses password auth to change OPNsense password to ADMIN_PASSWORD
   - Updates `working_password` fact after successful change
3. **Phase 3**: SSH Key Deployment via Ephemeral API Key (NEW - WORKING)
   - Copy `create-apikey.php` to Proxmox using Ansible `copy` module
   - SCP script to OPNsense
   - Generate temporary API key via PHP script
   - Get root user UUID using `xmllint --xpath 'string(//user[uid=0]/@uuid)' /conf/config.xml`
   - Add SSH public key via `/api/auth/user/set/{uuid}` (sends RAW key, not base64)
   - Call `/usr/local/opnsense/scripts/auth/sync_user.php -u root` to apply to filesystem
   - Verify SSH key works
   - Delete temporary API key via `/api/auth/user/delApiKey/{id}`
   - Clean up scripts from both systems

**Test Results**: Task 2147483644 completed successfully, SSH key authentication confirmed working.

**Key Commits**:
- `b7ca814` - Fix SSH key deployment via ephemeral API key
- `c5b5cc5` - Fix grep pattern escaping in password verification
- `e3c6f02` - Fix path to create-apikey.php (go up 2 dirs, not 1)
- `f3e505e` - Add password auth to API key setup SSH commands
- `7740678` - Get UUID from config.xml using xmllint (API doesn't return it)

---

## What's Blocked

### 2. Semaphore Integration (opnsense-semaphore-integration.yml) ❌

**Playbook**: `ansible/playbooks/services/opnsense-semaphore-integration.yml`

**Working So Far**:
- ✅ SSH key verification
- ✅ Semaphore API connectivity test
- ✅ Check if OPNsenseAPI environment already exists
- ✅ Copy create-apikey.php to Proxmox (uses `copy` module)
- ✅ Upload script to OPNsense via SCP
- ✅ Generate new API key via PHP script
- ✅ Test new API key works

**BLOCKED AT**: Line 155 - Creating OPNsenseAPI environment in Semaphore

**Error**: Ansible YAML syntax error
```
ERROR! found unacceptable key (unhashable type: 'AnsibleMapping')
The offending line:
    project_id: {{ project_id | int }}
                 ^ here
```

**Root Cause**: Ansible requires template expressions at the start of a value to be quoted, but we need `project_id` to be an actual integer in the resulting JSON, not a string.

---

## Technical Analysis

### Semaphore Environment API Structure (from working bootstrap code)

**File**: `bootstrap/lib/semaphore-api.sh`

**Correct structure** (lines 416-440, ServicePasswords):
```json
{
  "name": "ServicePasswords",
  "project_id": 1,  // <-- INTEGER, not string
  "json": "{}",  // <-- Stringified JSON for non-secret variables
  "env": "{}",
  "secrets": [
    {
      "type": "var",
      "name": "ADMIN_PASSWORD",
      "secret": "actual-password-here",
      "operation": "create"
    },
    {
      "type": "var",
      "name": "SERVICES_PASSWORD",
      "secret": "actual-password-here",
      "operation": "create"
    }
  ]
}
```

**Key Points**:
1. `project_id` must be an INTEGER (not quoted string)
2. `json` field contains stringified JSON for NON-SECRET variables
3. `env` field is always `"{}"`
4. `secrets` array contains SECRET variables with structure: `{type, name, secret, operation}`
5. Each secret needs `operation: "create"` on first creation

### What We Need for OPNsenseAPI

```json
{
  "name": "OPNsenseAPI",
  "project_id": 1,
  "json": "{\"OPNSENSE_API_URL\":\"https://10.10.20.1\"}",
  "env": "{}",
  "secrets": [
    {
      "type": "var",
      "name": "OPNSENSE_API_KEY",
      "secret": "<actual-key-from-php-script>",
      "operation": "create"
    },
    {
      "type": "var",
      "name": "OPNSENSE_API_SECRET",
      "secret": "<actual-secret-from-php-script>",
      "operation": "create"
    }
  ]
}
```

### Current Playbook (BROKEN - lines 145-168)

```yaml
- name: Create OPNsenseAPI environment in Semaphore
  uri:
    url: "{{ semaphore_url }}/api/project/{{ project_id }}/environment"
    method: POST
    headers:
      Authorization: "Bearer {{ semaphore_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "OPNsenseAPI"
      project_id: {{ project_id | int }}  # <-- SYNTAX ERROR: not quoted
      json: "{{ {'OPNSENSE_API_URL': 'https://' + opnsense_ip} | to_json }}"
      env: "{}"
      secrets:
        - type: "var"
          name: "OPNSENSE_API_KEY"
          secret: "{{ apikey_json.key }}"
          operation: "create"
        - type: "var"
          name: "OPNSENSE_API_SECRET"
          secret: "{{ apikey_json.secret }}"
          operation: "create"
    status_code: [201, 204]
```

**Problem**:
- Line 155: `project_id: {{ project_id | int }}` causes Ansible YAML parser error
- If quoted: `project_id: "{{ project_id | int }}"` becomes string `"1"` not integer `1`
- Semaphore API rejects with 400 Bad Request when project_id is a string

### Manual Test That WORKED

```bash
curl -sS --cookie /tmp/sem.cookies -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "name": "TestOPNsenseAPI",
    "project_id": 1,
    "json": "{\"OPNSENSE_API_URL\":\"https://10.10.20.1\"}",
    "env": "{}",
    "secrets": [
      {
        "type": "var",
        "name": "OPNSENSE_API_KEY",
        "secret": "test-key-123",
        "operation": "create"
      },
      {
        "type": "var",
        "name": "OPNSENSE_API_SECRET",
        "secret": "test-secret-456",
        "operation": "create"
      }
    ]
  }' \
  http://10.10.20.10:3000/api/project/1/environment

# Result: {"id":5,"name":"TestOPNsenseAPI","project_id":1,...}
```

---

## Proposed Solution

Use `set_fact` to construct the body with proper types, then pass to `uri` module:

```yaml
- name: Prepare OPNsenseAPI environment payload
  set_fact:
    opnsense_env_payload:
      name: "OPNsenseAPI"
      project_id: "{{ project_id | int }}"
      json: "{{ {'OPNSENSE_API_URL': 'https://' + opnsense_ip} | to_json }}"
      env: "{}"
      secrets:
        - type: "var"
          name: "OPNSENSE_API_KEY"
          secret: "{{ apikey_json.key }}"
          operation: "create"
        - type: "var"
          name: "OPNSENSE_API_SECRET"
          secret: "{{ apikey_json.secret }}"
          operation: "create"

- name: Create OPNsenseAPI environment in Semaphore
  uri:
    url: "{{ semaphore_url }}/api/project/{{ project_id }}/environment"
    method: POST
    headers:
      Authorization: "Bearer {{ semaphore_token }}"
      Content-Type: "application/json"
    body_format: json
    body: "{{ opnsense_env_payload }}"
    status_code: [201, 204]
```

**Rationale**:
- `set_fact` with `body_format: json` in `uri` module should handle type conversion correctly
- Separates payload construction from API call for debugging
- Similar pattern used successfully elsewhere in Ansible

---

## Current System State

**Proxmox Host**: 192.168.1.10
**OPNsense**: 10.10.20.1
**Management VM**: 10.10.20.10

**Passwords** (from quickstart output):
```
ADMIN_PASSWORD: ShIngl3-kiW1-educati0n-pRun1Ng-uNs1ghTly
SERVICES_PASSWORD: bronz1ng-Unflaw3D-upR1ghT
```

**Semaphore**: http://10.10.20.10:3000
- Login: admin / bronz1ng-Unflaw3D-upR1ghT
- Cookie stored at `/tmp/sem.cookies` on Proxmox host

**SSH Keys**:
- ✅ OPNsense SSH key working at `/root/.credentials/opnsense/id_ed25519`
- Test: `ssh root@192.168.1.10 "ssh -i /root/.credentials/opnsense/id_ed25519 root@10.10.20.1 hostname"`
- Result: `OPNsense.internal`

**Environments in Semaphore**:
1. Empty (ID: 1)
2. ServicePasswords (ID: 2) - ✅ Working
3. ProxmoxAPI (ID: 3) - ✅ Working
4. SemaphoreAPI (ID: 4) - ✅ Working
5. **OPNsenseAPI** - ❌ NOT CREATED (this is what's blocked)

**Recent Tasks**:
- 2147483644: OPNsense 1: Establish Secure Access - ✅ **SUCCESS**
- 2147483632: OPNsense 2: Semaphore Integration - ❌ ERROR (environment creation)
- 2147483634: Orchestrate Services - ❌ ERROR (stops at Semaphore Integration failure)

---

## Files Modified (Already Committed)

```
ansible/playbooks/services/opnsense-secure-access.yml
  - Complete rewrite of Phase 2/3 to use ephemeral API key method
  - WORKING

ansible/playbooks/services/opnsense-semaphore-integration.yml
  - Fixed create-apikey.php path (use copy module)
  - Fixed environment structure (json/env/secrets fields)
  - BLOCKED at line 155 (YAML syntax vs JSON integer type)

tools/orchestrate-services.py
  - Fixed template name: "OPNsense 2: Semaphore Integration"
```

---

## Next Steps

### Immediate (Fix Environment Creation)

1. **Test `set_fact` approach** in opnsense-semaphore-integration.yml:
   - Create `opnsense_env_payload` fact with all body fields
   - Pass fact to `uri` module's `body` parameter
   - Verify `project_id` becomes integer in resulting JSON

2. **Alternative if set_fact doesn't work**:
   - Use `template` module to generate JSON file
   - Use `shell` module with `curl` to POST the file
   - Less elegant but guaranteed to work (proven in manual test)

3. **Test on running system**:
   - System is ready at 192.168.1.10
   - Passwords in this document
   - Just trigger "Orchestrate Services" after fix

### After Environment Creation Works

4. **Complete orchestration sequence**:
   - OPNsense 1: Establish Secure Access ✅
   - OPNsense 2: Semaphore Integration (fix this)
   - OPNsense 3: Post-Configuration
   - AdGuard 1: Deploy Container Service
   - Homer 1: Deploy Dashboard Service

5. **Document complete flow** in main docs

6. **Test full quickstart** from clean state

---

## API Endpoints Reference

### OPNsense User Management
```
GET  /api/auth/user/get                    # Get user details
POST /api/auth/user/set/{uuid}             # Update user (returns {"result":"saved"})
GET  /api/auth/user/searchApiKey           # List API keys
POST /api/auth/user/delApiKey/{id}         # Delete API key
```

### Semaphore Environment Management
```
GET    /api/project/{pid}/environment      # List environments
POST   /api/project/{pid}/environment      # Create environment
GET    /api/project/{pid}/environment/{id} # Get environment details
DELETE /api/project/{pid}/environment/{id} # Delete environment
```

---

## Useful Commands

### Check Semaphore Tasks
```bash
ssh root@192.168.1.10 "curl -sS --cookie /tmp/sem.cookies \
  'http://10.10.20.10:3000/api/project/1/tasks?sort=created&order=desc' | \
  jq -r '.[] | \"\(.id) | \(.tpl_alias) | \(.status)\"' | head -10"
```

### Test SSH Key to OPNsense
```bash
ssh root@192.168.1.10 "ssh -i /root/.credentials/opnsense/id_ed25519 \
  -o StrictHostKeyChecking=no root@10.10.20.1 'echo TEST && hostname'"
```

### List Semaphore Environments
```bash
ssh root@192.168.1.10 "curl -sS --cookie /tmp/sem.cookies \
  'http://10.10.20.10:3000/api/project/1/environment' | jq '.[] | {name, id}'"
```

### Manual Environment Creation Test
```bash
ssh root@192.168.1.10 'curl -sS --cookie /tmp/sem.cookies \
  -X POST -H "Content-Type: application/json" \
  -d '"'"'{
    "name": "TestEnv",
    "project_id": 1,
    "json": "{}",
    "env": "{}",
    "secrets": []
  }'"'"' \
  http://10.10.20.10:3000/api/project/1/environment'
```

---

## Context

- **Project**: PrivateBox - Commercial consumer firewall appliance (SubRosa ApS, Denmark)
- **Hardware**: Intel N150 mini-PC, €399 retail
- **Status**: Core SSH automation WORKING, environment creation BLOCKED
- **Impact**: Cannot complete automated orchestration until environment creation fixed

---

## Important Notes

1. **SSH Key Method PROVEN**: The ephemeral API key approach for SSH key deployment is solid and working reliably.

2. **Environment Structure VERIFIED**: Manual curl test succeeded with exact structure needed. Issue is purely Ansible YAML/JSON type handling.

3. **System Ready for Testing**: Fresh deployment at 192.168.1.10, all passwords documented, just need to fix one task.

4. **Type Handling is Critical**: `project_id` MUST be integer. Semaphore API strictly validates this (returns 400 if string).

5. **Bootstrap Code is Reference**: The bash script in `bootstrap/lib/semaphore-api.sh` has working examples for all environment types. Use it as reference.

END HANDOVER
