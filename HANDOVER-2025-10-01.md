# HANDOVER: OPNsense API Key Implementation - 2025-10-01

## Current Objective
Implement unique API key generation for each OPNsense deployment (instead of shared hardcoded credentials).

---

## What Was Implemented (Commits f126287, 96f400a, 3e83e32)

### 1. Created API Key Generation Script
**File:** `ansible/files/opnsense/create-apikey.php`
- Uses OPNsense internal libraries (`OPNsense\Auth\User`)
- Generates unique API key/secret per deployment
- Returns JSON: `{"result":"ok","key":"...","secret":"..."}`
- Tested successfully - creates working API keys

### 2. Modified Template Config
**File:** `bootstrap/configs/opnsense/config.xml`
- Changed: `<apikeys>d1gvVYrZ...</apikeys>` → `<apikeys/>`
- Fresh deployments now start with ZERO API keys
- Removed hardcoded shared credential

### 3. Renamed and Enhanced Playbook
**File:** `ansible/playbooks/services/opnsense-semaphore-integration.yml`
- Previously: `opnsense-register-semaphore.yml`
- Added **Phase 2: OPNsense API Key Management**
  - Checks if "OPNsenseAPI" environment exists in Semaphore
  - If not: generates key, tests it, stores in Semaphore
  - If exists: tests stored credentials, fails if invalid
  - Creates environment with: OPNSENSE_API_URL, OPNSENSE_API_KEY, OPNSENSE_API_SECRET
- Phases renumbered: SSH Key (3), Inventory (4), Templates (5)

---

## THE BLOCKING ISSUE

### Test Deployment Failed
**What happened:** Ran fresh quickstart, deployment stuck for 2+ hours

**Where:** `opnsense-secure-access.yml` playbook stuck at line 252
**Task:** "Verify config.xml was modified (web UI password changed)"
**Symptom:** Task hangs forever, SSH with key returns "Permission denied"

### Root Cause Analysis

**Discovery 1: OPNsense stores SSH keys in config.xml**
```xml
<user>
  <authorizedkeys>base64-encoded-public-key</authorizedkeys>
</user>
```

**Discovery 2: password.php wipes filesystem SSH keys**
Current broken flow:
1. Playbook appends SSH key to `/root/.ssh/authorized_keys` ✅
2. Playbook runs `password.php` to change password ✅
3. password.php modifies `/conf/config.xml`
4. password.php regenerates `/root/.ssh/authorized_keys` FROM config.xml `<authorizedkeys>` field
5. Our newly added key is GONE (wasn't in config.xml) ❌
6. Playbook tries to verify via SSH with key → Permission denied ❌
7. Stuck forever

**Why this wasn't seen before:**
- Previous deployments had existing state/keys
- Fresh deployment exposed the race condition
- `password.php` was recently introduced (commit 114fc4b)
- Old method used `configctl system password` (didn't wipe keys)

### Template Has Pre-Embedded Key (DO NOT USE)
```xml
<authorizedkeys>c3NoLWVkMjU1MTkgQUFBQUMzTnphQzFsWkRJMU5URTVBQUFBSUQ4cWdVeFAyRlM0ek83ZTVEODFsdlorRzZHQWU1ZFRldGtLSWUwV3dxWkQgY2xhdWRlLW9wbnNlbnNlLWFjY2Vzcw==</authorizedkeys>
```
Decodes to: `ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAID8qgUxP2FS4zO7e5D81lvZ+G6GAe5dTetkKIe0WwqZD claude-opnsense-access`

**DIRTY - DO NOT USE** (hardcoded in repo, shared across deployments)

---

## THE SOLUTION (Agreed With User)

### New Flow: Ephemeral API Key for SSH Bootstrap

```
1. SSH with default password "opnsense"
2. Change password to ADMIN_PASSWORD (via SSH + password auth)
3. Create TEMPORARY API key (via SSH + password auth + create-apikey.php)
4. Use temp API key to add SSH public key to config.xml <authorizedkeys>
   - GET /api/auth/user/get_user
   - Modify authorizedkeys field with base64-encoded public key
   - POST /api/auth/user/set_user
5. Test SSH key authentication works
6. Delete temporary API key (via API: DELETE /api/auth/user/del_api_key)
7. Continue with SSH key auth only
```

**Later** in `opnsense-semaphore-integration.yml`:
- Create a DIFFERENT permanent API key for WireGuard automation
- Store that one in Semaphore "OPNsenseAPI" environment

**Key insight:** Temp API key exists for ~30 seconds just to bootstrap SSH, then self-destructs.

---

## CURRENT SYSTEM STATE

### Proxmox Host: 192.168.1.10
**VMs Deployed (Fresh):**
- VM 100: OPNsense (10.10.20.1)
- VM 9000: Management VM (10.10.20.10)

### Passwords (Current Deployment)
```
ADMIN_PASSWORD: hypnoTiz3-4FaR-hand1er-uNcoi1Ed-5pliNTEr
SERVICES_PASSWORD: emP0wer-curs3-sacram3Nt
```

**OPNsense:**
- Default password: `opnsense` ✅ (still works)
- Web UI password: Changed to ADMIN_PASSWORD (but SSH key broken)
- SSH password auth: Works with ADMIN_PASSWORD ✅
- SSH key auth: BROKEN ❌

### Semaphore (http://10.10.20.10:3000)
**Login:** admin / emP0wer-curs3-sacram3Nt

**Environments:**
- Empty
- ServicePasswords (has ADMIN_PASSWORD, SERVICES_PASSWORD)
- ProxmoxAPI
- SemaphoreAPI
- **OPNsenseAPI: NOT CREATED** (playbook never ran due to stuck task)

**Stuck Tasks:**
- Task 2147483644: "OPNsense 1: Establish Secure Access" - **running** (stuck 2+ hours)
- Task 2147483645: "Orchestrate Services" - **running** (waiting for 2147483644)
- Task 2147483643: "OPNsense 2: Semaphore Integration" - **error** (no SSH access)

---

## API KEYS DISCOVERED

### Old Hardcoded Keys (REMOVED from repo)
```
Key: d1gvVYrZXIblXHP/6ci71Vm+lFVIWTGtp7zaDLDe/+3txOfT+TEzeFX9MIvDUtETvdnxdA45zaD3cR/F
Secret: IB0UXhEyLLN9N93kapc/fNwO1gSBYTSANf5Nk0rzbG++WNO+OVCyAfnSqsgvZ6UxjRV3lgPvjC8wRnVR
```
**Status:** Was in config.xml template, now removed ✅

### Test Key Generated (From Manual Test)
```
Key: 7IPdxRs6lzgX7lov82s7xs94OenVe2htCgH2R0A9N7/AmTBUG4iyOegPL+FbtGAa543utRVRMgzBIT7F
Secret: Khn9CUZ4IusGR/n3Iizpch4A9Md0eipmlxsTlP7Ucoyw6I8W8/izzWgPvUHriOjlNt08qUOnA5uujQ4j
```
**Status:** Still in running OPNsense config.xml (3 keys total in system)

---

## OPNsense API Endpoints (Researched)

### Auth/User Management
```
GET  /api/auth/user/get_user?username=root
POST /api/auth/user/set_user/{uuid}
GET  /api/auth/user/search_api_key
POST /api/auth/user/add_api_key/{username}
POST /api/auth/user/del_api_key/{uuid}
```

### WireGuard (For Future Use)
```
POST /api/wireguard/server/add_server
POST /api/wireguard/client/add_client
POST /api/wireguard/service/reconfigure
GET  /api/wireguard/service/status
```

---

## NEXT STEPS (Implementation Required)

### 1. Fix opnsense-secure-access.yml
**File:** `ansible/playbooks/services/opnsense-secure-access.yml`

**Required changes:**
1. Keep Phase 1 (Intelligence Gathering) as-is
2. **Phase 2: Password Change** (if needed)
   - Use sshpass with `working_password` (default "opnsense")
   - Run password.php to change to ADMIN_PASSWORD
   - Verify new password works via sshpass

3. **Phase 3: SSH Key Bootstrap** (NEW - if needed)
   - Generate SSH keypair locally (`/root/.credentials/opnsense/id_ed25519`)
   - Read public key
   - Create temp API key:
     ```bash
     ssh (password) → upload create-apikey.php → execute → capture JSON
     ```
   - Use temp API key to add SSH key:
     ```
     GET /api/auth/user/get_user (returns user data with UUID)
     Append base64(public-key) to authorizedkeys field
     POST /api/auth/user/set_user/{uuid}
     ```
   - Test SSH key works
   - Delete temp API key via API
   - Delete create-apikey.php from /tmp/

4. Keep remaining phases as-is

### 2. Research Question
**CRITICAL:** Verify OPNsense API supports modifying `authorizedkeys` field:
```bash
# Test on running system:
curl -k -u "KEY:SECRET" https://10.10.20.1/api/auth/user/get_user?username=root
# Check if response includes authorizedkeys field
# Test if set_user accepts authorizedkeys modification
```

### 3. Test Sequence
1. Kill stuck Semaphore tasks (2147483644, 2147483645)
2. Delete VMs, re-run quickstart with fixed playbook
3. Verify:
   - Password changes successfully
   - SSH key gets added to config.xml
   - API key self-destructs
   - opnsense-semaphore-integration.yml runs successfully
   - OPNsenseAPI environment created in Semaphore
   - Permanent API key stored for WireGuard use

---

## FILES CHANGED (Already Committed)

```
bootstrap/configs/opnsense/config.xml
  - Removed hardcoded API key

ansible/files/opnsense/create-apikey.php
  - NEW: PHP script for API key generation

ansible/playbooks/services/opnsense-semaphore-integration.yml
  - Renamed from opnsense-register-semaphore.yml
  - Added Phase 2: API Key Management
```

## FILES TO MODIFY (Not Started)

```
ansible/playbooks/services/opnsense-secure-access.yml
  - Fix SSH key deployment to use ephemeral API key method
```

---

## USEFUL COMMANDS

### Check Semaphore Tasks
```bash
ssh root@192.168.1.10 "curl -sS --cookie /tmp/sem-test.cookies 'http://10.10.20.10:3000/api/project/1/tasks?sort=created&order=desc' | jq -r '.[] | \"\(.id) | \(.tpl_alias) | \(.status)\"' | head -10"
```

### Login to Semaphore (from Proxmox)
```bash
ssh root@192.168.1.10 "curl -sS --cookie-jar /tmp/sem-test.cookies -X POST -H 'Content-Type: application/json' -d '{\"auth\":\"admin\",\"password\":\"emP0wer-curs3-sacram3Nt\"}' http://10.10.20.10:3000/api/auth/login"
```

### Test OPNsense SSH
```bash
# With password:
ssh root@192.168.1.10 "SSHPASS='hypnoTiz3-4FaR-hand1er-uNcoi1Ed-5pliNTEr' sshpass -e ssh -o StrictHostKeyChecking=no root@10.10.20.1 'echo TEST'"

# With key (currently broken):
ssh root@192.168.1.10 "ssh -i /root/.credentials/opnsense/id_ed25519 -o StrictHostKeyChecking=no root@10.10.20.1 'echo TEST'"
```

### Test API Key
```bash
ssh root@192.168.1.10 "curl -k -u 'KEY:SECRET' https://10.10.20.1/api/core/system/status"
```

---

## CONTEXT
- **Project:** PrivateBox - Commercial consumer firewall appliance (SubRosa ApS, Denmark)
- **Hardware:** Intel N150 mini-PC, €399 retail
- **Goal:** Unique API keys per deployment for security
- **Blocker:** SSH key deployment broken by password change mechanism
- **Solution:** Use ephemeral API key to bootstrap SSH, then destroy key
- **Status:** Implementation 80% complete, blocked on SSH key fix

---

## IMPORTANT NOTES
1. OPNsense stores SSH keys in config.xml `<authorizedkeys>` field, NOT just filesystem
2. password.php regenerates `/root/.ssh/authorized_keys` from config.xml
3. Must add keys to config.xml to survive password changes
4. Use API to modify config.xml safely
5. Temp API key pattern avoids leaving credentials in system
6. create-apikey.php tested and working
7. Final API key (for WireGuard) will be created in separate playbook

END HANDOVER
